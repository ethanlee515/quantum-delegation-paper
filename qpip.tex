\section{Delegation Protocol for $\QPIP_1$ Client}

In this section, we construct a one-message $\QPIP_1$ delegation protocol for $\SampBQP$.
At a high level, it is a cut-and-choose protocol.
The server constructs multiple copies of the ground state as certificates,
then the client randomly chooses a copy to output and checks the rest.
Unfortunately our approach incurs inverse polynomial soundness errors.

There are two main challenges to this cut-and-choose approach.
First, the client needs to reliably extract the circuit output from its corresponding ground state.
We accomplish this by padding the circuit with identity gates at the end.
By doing so, the clock register collapses to after the last non-identity gate with high probability.

The other challenge is that a cheating prover's certificates can be arbitrarily entangled,
so common techniques such as Chernoff bounds can't be applied as-is.
This wasn't a challenge for $\Piblind$ for $\BQP$ earlier because...
\Ethan{TODO; need brief and intuitive explanation}
In our case with $\SampBQP$, we overcome this challenge instead by using de Finetti's theorem
to approximate our measurement results with that of some unentangled copies,
within inverse polynomial errors.

\Ethan{Actual technical part starts here}

\begin{protocol}{$\QPIP_1$ protocol $\PiSamp=(\PSamp, \VSamp)$ for the $\SampBQP$ instance $(D_x)_{x\in\set{0, 1}^*}$}
	\label{ProtoQPIP1}

	Inputs: \Ethan{Should the $\SampBQP$ instance be an input?}
	\begin{itemize}
		\item Classical input $x\in\zo^n$ to the $\SampBQP$ instance
		\item Error parameter $\varepsilon\in(0, 1)$
	\end{itemize}

	Ingrediants:
	\begin{itemize}
		\item Let $C$ be a quantum circuit consisting of only Hadamard and Toffoli gates, which on input $x$ samples from some $C_x$ such that $\norm{C_x-D_x}\leq\varepsilon$.
		\item Let $T$ be the number of gates in $C$.
		\item Let $C'$ be $C$ padded with $\frac{T}{\varepsilon}$ identity gates at the end.
		\item Let $H_{C'(x)}$ be the local Hamiltonian instance associated with the computation of $C'(x)$.
		\item Let $\ket{\psi_{C'(x)}}$ be the ground state of $H_{C'(x)}$.
		\item Let $\cVGS$ be the way to verify said ground state as defined in \Cref{AlgGroundStateCheck}. \Ethan{TODO wording needs fix...? How?}
	\end{itemize}

	Protocol:
	\begin{enumerate}
		\item\label{step:qpip1-state-gen} The honest prover prepares $M=\frac{T^{21}}{\varepsilon^{33}}$ copies of $\ket{\psi_{C'(x)}}$ and sends all of it to the verifier qubit-by-qubit.
		\item\label{step:qpip1-verify} The verifier privately samples $I\subset[M]$ s.t. $\abs{I}=m$ where $m=\frac{T^{10}}{\varepsilon^{15}}$, and $k\xleftarrow{\$}[M]\setminus I$. \hannote{$\xleftarrow{\$}$ ?}
			For $i$ from $1$ to $M$, it chooses what to do to the $i$-th copy, $\rho_i$, as follows:
		\begin{enumerate}
			\item If $i\in I$, run $z_i\leftarrow\cV_{\GS}(\rho_i)$.
			\item Else if $i=k$, measure the data register \Ethan{Revisit this name} of $\rho_i$ under the standard basis and save the outcome as $y$.
			\item Else, discard $\rho_i$.
		\end{enumerate}
			Let $Z=\sum_{i\in I} z_i$. If $Z>\frac{m}{2}-\kappa m$ where $\kappa=\frac{c\varepsilon^2}{2\left(T+\frac{T}{\varepsilon}\right)^5}$ and $c\in\bbR$ as in \Cref{cor:HamCheck} then the verifier outputs $(acc, y)$. Else, it outputs $(rej, \bot)$.
	\end{enumerate}
\end{protocol}

Note that $\VSamp$ only needs to apply $X$ and $Z$ measurements, and is classical otherwise.
It is simple to check that $\PiSamp$ runs in $\poly(T, \varepsilon^{-1})$ time.
We now show its completeness and soundness.
Particularly, we prove that it has $O(\varepsilon)$ soundness errors
with the understanding that by relabelling $\varepsilon'=O(\varepsilon)$ and modifying $\PiSamp$ accordingly,
one can achieve $\varepsilon'$ soundness errors while maintaining completeness and running time properties.
  
\begin{thm}
    \label{QPIP1thm}
	$\PiSamp$ has negligible completeness error and $O(\varepsilon)$ soundness error.
\end{thm}
\begin{prf}
	For completeness, notice $z_i$ are i.i.d. Bernoulli trials with success probability $\frac{1}{2}$.
	So we can apply Chernoff bound (\Cref{thm:Chernoff}) with $\mu=\frac{m}{2}$ and $\delta=\frac{c\varepsilon^2}{\left(T+\frac{T}{\varepsilon}\right)^5}$ to get
	$$\Prob{Z>\frac{m}{2}-\varepsilon m}\leq2e^{-\frac{\mu\delta^2}{3}}=\negl(\varepsilon^{-1}).$$
	
	\Ethan{Should be negl lambda}

	Now we show soundness.

	Suppose $\PSampstar$ is a cheating prover that sends some $\sigma$ to the verifier.

	The first step of our analysis is to use de Finetti's theorem.
	Randomly picking $m+1$ out of $M$ registers is equivalent to first applying a random permutation then taking the first $m+1$ registers.
	A random permutation, in turn, is a classical mix over all possible permutations:
	$$\sigma'=\frac{1}{\abs{\Sym(M)}}\sum_{\Pi\in\Sym(M)}\Pi\sigma\Pi^\dagger.$$
	It is simple to check that $\sigma'$ is permutation-invariant:
	fix $\tilde{\Pi}\in\Sym(M)$, then
	$$\tilde{\Pi}\sigma'\tilde{\Pi}^\dagger
	=\frac{1}{\abs{\Sym(M)}}\sum_{\Pi\in\Sym(M)}\tilde{\Pi}\Pi\sigma\Pi^\dagger\tilde{\Pi}^\dagger
	=\frac{1}{\abs{\Sym(M)}}\sum_{\hat{\Pi}\in\Sym(M)}\hat{\Pi}\sigma\hat{\Pi}^\dagger
	=\sigma'$$
	where the second equality is by relabeling $\tilde{\Pi}\Pi=\hat{\Pi}$.

	\Ethan{$\sigma'_{\leq m+1}$ Maybe this notation for traced out state}

	Now we apply de Finetti's theorem (\Cref{deFinetti}) to approximate our measurement result on $\sigma$ with that of a classical mix over $M$-fold tensor products of identical copies of some states $\tau_j$.
	That is, there exists some $\rho=\sum_j w_j\tau_j^{\otimes M}$
	such that for all quantum-classical channels $\Lambda_i$ acting on registers with size of $\ket{\psi_{C'(x)}}$:
	$$\norm{\Lambda_1\otimes\ldots\otimes\Lambda_{m+1}(\sigma'-\rho)}
	\leq\sqrt{\frac{2m^2\left(n+T+\frac{T}{\varepsilon}\right)}{M-m}}
	=O(\varepsilon).$$
	In our context, for $1\leq i\leq m$, $\Lambda_i$ corresponds to measurements chosen by $\cVGS$.
	$\Lambda_{m+1}$ is measurement on the data register of $\rho_k$.
	
	\Ethan{TODO special font for acc/rej}
	
	\Ethan{Just say what would happen if V accs this instead}
	
	Now we claim that for each component $\tau_j$,
	if $\PSampstar$ had sent $\tau_j^{\otimes M}$ instead then the soundness error is $O(\varepsilon)$.
	Let $p_j$ be the probability that $\cVGS(\tau_j)=acc$, we seperate $\tau_j$ terms into two cases.

	First suppose $p_j<\frac{1}{2}-2\kappa$,
	then a standard Chernoff bound argument can be applied show that this case has negligible acceptance probabilities.
	That is, it outputs $(rej, \bot)$ with overwhelming probability, hence has negligible soundness errors.

	Now suppose $p_j\geq\frac{1}{2}-2\kappa$.
	By \Cref{cor:HamCheck} we have a lower bound for the fidelity between $\tau_j$ and $\ket{\psi_{C'(x)}}$:
	$$p_j>\frac{1}{2}-2\kappa\Rightarrow F(\tau_j, \ket{\psi_{C'(x)}}\bra{\psi_{C'(x)}})\geq1-\varepsilon^2.$$
	which in turn implies a lower bound on the respective trace distance:
	$$\frac{1}{2}\norm{\tau_j - \ket{\psi_{C'(x)}}\bra{\psi_{C'(x)}}}_1<\varepsilon.$$
	Let $(d, y)$ be $\VSamp$'s output \Ethan{on input tau j}. Suppose $d=acc$, then $y$ would be the measurement on $\tau_j$'s data register,
	which is $\varepsilon$-close to that on $\ket{\psi_{C'(x)}}$.
	As the clock register is traced out from $\ket{\psi_{C'(x)}}$, the data register has $1-\varepsilon$ probability to contain $C(x)$ due to the padding.
	So $y$ is $O(\varepsilon)$-close to $y_{ideal}$ when $d=acc$,
	which implies that $(d, y)$ is $O(\varepsilon)$-close to $(d, y_{ideal})$.

	The cheating prover's strategies corresponding to $\tau_j$ all have $O(\varepsilon)$ soundness errors.
	As $\rho$ is a convex combination \Ethan{More equations...} of these strategies, we conclude the same about it.
	Finally, as the outputs corresponding to $\sigma$ is $\varepsilon$-close to that of some $\rho$,
	by data processing inequality we conclude that $\PiSamp$ has $O(\varepsilon)$ soundness errors.
\end{prf}

\Ethan{Switch y and z}
