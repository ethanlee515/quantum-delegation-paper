\section{Delegation Protocol for $\QPIP_1$ Client}

In this section, we construct a one-message $\QPIP_1$ delegation protocol for $\SampBQP$.
At a high level, it is a cut-and-choose protocol.
The server constructs multiple copies of the ground state as certificates,
then the client randomly chooses a copy to output and checks the rest.
Unfortunately our approach incurs inverse polynomial soundness errors.

There are two main challenges to this cut-and-choose approach.
First, the client needs to reliably extract the circuit output from its corresponding ground state.
We accomplish this by padding the circuit with identity gates at the end.
By doing so, the clock register collapses to after the last non-identity gate with high probability.

The other challenge is that a cheating prover's certificates can be arbitrarily entangled,
so common techniques such as Chernoff bounds can't be applied as-is.
This wasn't a challenge for $\Piblind$ for $\BQP$ earlier because...
\Ethan{TODO; need brief and intuitive explanation}
In our case with $\SampBQP$, we overcome this challenge instead by using de Finetti's theorem
to approximate our measurement results with that of some unentangled copies,
within inverse polynomial errors.

\Ethan{Actual technical part starts here}

We start with a $\SampBQP$ problem $(D_x)_{x\in\set{0, 1}^*}$ and an input $x$,
then there exists some quantum circuit $C$ that samples from $D_x$ within desired accuracy. \Ethan{Define some kinda $\varepsilon_0$ for this}
We assume without loss of generality that $C$ comprises of only Hadamard and Toffoli gates.
We present our protocol that allows a client to verifiably obtain the measurement outcome of $C(x)$.

\begin{protocol}{$\QPIP_1$ protocol $\PiSamp=(\PSamp, \VSamp)$ for the computation $C(x)$ with error parameter $\varepsilon$}
	\label{ProtoQPIP1}

	Inputs:
	\begin{itemize}
		\item Error parameter $\varepsilon\in(0, 1)$
		\item Input string $x\in\set{0, 1}^n$
		\item Quantum circuit $C$ of size $T$ consisting of only Hadamard and Toffoli gates \Ethan{move this into ingredients and put SampBQP instance as inputs}
	\end{itemize}

	Ingrediants:
	\begin{itemize}
		\item Let $C'$ be $C$ padded with $\frac{T}{\varepsilon}$ identity gates at the end.
		\item Let $\ket{\psi_{C'(x)}}$ be the local Hamiltonian ground state associated with $C'$ as defined in \Cref{thm:LHReduction}. \Ethan{Also bring $H_C$ in. More descriptions. Make it more intuitive.}
		\item $\cVGS$ be the way to check said ground state as defined in \Cref{AlgGroundStateCheck}. \Ethan{TODO wording needs fix}
		\item Define $c\in\bbR$ as in \Cref{cor:HamCheck}. \Ethan{Just make sure it's less than 10 and write 10. Also it shouldn't be an ingredient if it's $c$}
	\end{itemize}

	Protocol:
	\begin{enumerate}
		\item The honest prover prepares $M=\frac{T^{21}}{\varepsilon^{33}}$ copies of $\ket{\psi_{C'(x)}}$ and sends all of it to the verifier qubit-by-qubit.
		\item The verifier privately samples $I\subset[M]$ s.t. $\abs{I}=m$ where $m=\frac{T^{10}}{\varepsilon^{15}}$, and $k\xleftarrow{\$}[M]\setminus I$.
			For $i$ from $1$ to $M$, it chooses what to do to the $i$-th copy, $\rho_i$, as follows:
		\begin{enumerate}
			\item If $i\in I$, run $z_i\leftarrow\cV_{\GS}(\rho_i)$.
			\item Else if $i=k$, measure the data register \Ethan{Revisit this name} of $\rho_i$ under the standard basis and save the outcome as $y$.
			\item Else, discard $\rho_i$.
		\end{enumerate}
			Let $Z=\sum_{i\in I} z_i$. If $Z>\frac{m}{2}-\kappa m$ where $\kappa=\frac{c\varepsilon^2}{2\left(T+\frac{T}{\varepsilon}\right)^5}$ then the verifier accepts and outputs $y$. Otherwise, it rejects.
	\end{enumerate}
\end{protocol}

Note that $\VSamp$ only needs to apply $X$ and $Z$ measurements, and is classical otherwise.
It is simple to check that $\PiSamp$ runs in $\poly(T, \varepsilon^{-1})$ time.
We now show its completeness and soundness.

\begin{thm}
    \label{QPIP1thm}
	$\PiSamp$ has negligible completeness error and $O(\varepsilon)$ soundness error.
\end{thm}
\begin{prf}
	For completeness, notice $z_i$ are i.i.d. Bernoulli trials with success probability $\frac{1}{2}$.
	So we can apply Chernoff bound (\Cref{thm:Chernoff}) \Ethan{Theorem numbering needs fix} with $\mu=\frac{m}{2}$ and $\delta=\frac{c\varepsilon^2}{\left(T+\frac{T}{\varepsilon}\right)^5}$ to get
	$$\Prob{Z>\frac{m}{2}-\varepsilon m}\leq2e^{-\frac{\mu\delta^2}{3}}=\negl(\varepsilon^{-1}).$$

	Now we show soundness.
	Suppose $\PSampstar$ is a cheating prover that sends some $\sigma$ to the verifier.

	The first step of our analysis is to use de Finetti's theorem.
	Randomly picking $m+1$ out of $M$ registers is equivalent to first applying a random permutation then taking the first $m+1$ registers.
	A random permutation, in turn, is a classical mix over all possible permutations:
	$$\sigma'=\frac{1}{\abs{\Sym(M)}}\sum_{\Pi\in\Sym(M)}\Pi\sigma\Pi^\dagger.$$
	It is simple to check that $\sigma'$ is permutation-invariant:
	fix $\tilde{\Pi}\in\Sym(M)$, then
	$$\tilde{\Pi}\sigma'\tilde{\Pi}^\dagger
	=\frac{1}{\abs{\Sym(M)}}\sum_{\Pi\in\Sym(M)}\tilde{\Pi}\Pi\sigma\Pi^\dagger\tilde{\Pi}^\dagger
	=\frac{1}{\abs{\Sym(M)}}\sum_{\hat{\Pi}\in\Sym(M)}\hat{\Pi}\sigma\hat{\Pi}^\dagger
	=\sigma'$$
	where the second equality is by relabeling $\tilde{\Pi}\Pi=\hat{\Pi}$.

	Now we apply de Finetti's theorem (\Cref{deFinetti}) to approximate $\sigma'$ with a classical mix over tensors of independent states.
	That is, there exists some $\rho=\sum_j w_j\rho_j^{\otimes m+1}$
	\Ethan{multiple copies to one copy? Say in words that rho j is one component of iids}
	such that for all quantum-classical channels $\Lambda_i$ on $n+T+\frac{T}{\varepsilon}$ qubits:
	$$\norm{\Lambda_1\otimes\ldots\otimes\Lambda_{m+1}(\sigma'-\rho)}
	\leq\sqrt{\frac{2m^2\left(n+T+\frac{T}{\varepsilon}\right)}{M-m}}
	=O(\varepsilon).$$
	
	\Ethan{In our context, lambda i is ground state check... etc. and rho 1 rho 2 are...}

	Let $p_j$ be the probability that $\cVGS(\rho_j)=acc$. Now we seperate the $\rho_j$ terms into two categories based on $p_j$.

	First suppose $p_j<\frac{1}{2}-2\kappa$,
	then a standard Chernoff bound argument can be applied show that this case has negligible acceptance probabilities,
	hence incurs negligible soundness errors.

    \Ethan{Fix the kets}
    
	Now suppose $p_j\geq\frac{1}{2}-2\kappa$.
	By \Cref{cor:HamCheck} we have a lower bound for the fidelity between $\rho_j$ and $\psi_{C'(x)}$:
	$$p_j>\frac{1}{2}-2\kappa\Rightarrow F(\rho_j, \psi_{C'(x)})\geq1-\varepsilon^2.$$
	which in turn implies a lower bound on the respective trace distance:
	$$T(\rho_j, \ket{\psi_{C'(x)}})<\varepsilon.$$
	\Ethan{Trace distance notation}

	The probability of measuring $t<T$ on the clock register of $\ket{\phi_{C'(x)}}$ is $O(\varepsilon)$ due to the padding,
	so the data register has $1-O(\varepsilon)$ probability to be $C(x)$ at this point.

	The soundness errors at each step is $O(\varepsilon)$, so the conclusion follows.
	\Ethan{Be more careful here. Actually sum up errors.}
\end{prf}
