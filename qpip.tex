\section{Delegation Protocol for Hybrid Client}

In this section, we construct a $\QPIP_1$ delegation protocol for $\SampBQP$.
The high level idea is cut-and-choose; that is,
the server constructs multiple copies of the ground state as certificates,
the client then randomly chooses a copy to output and checks the rest.
There are two main challenges to this approach.
First, the client needs to reliably extract the circuit's output from its corresponding ground state,
which can be accomplished by padding the circuit with identity gates at the end.
Then, the clock register measures into after the last gate with high probability,
which implies that the data register is in the circuit's final state.
The other challenge is that a cheating prover could create arbitrary entanglements between its certificates.
This challenge isn't present in the protocol for $\BQP$ because its soundness is one-sided.
That is, we allow a cheating server to cause the client to reject a yes-instance;
it just can't convince the client to accept a no-instance.
Because of this asymmetry, it turns out that any prover, honest or not, can't do better than sending $n$ identical copies of some state,
which allows the use of Chernoff bound.
Here we use de Finetti's theorem to approximate our measurement results with unentangled states,
which comes with a cost of inverse polynomial errors,
to also allow the use of Chernoff bounds.

\def\GS{\mathsf{GS}}
\nc{\PiGS}{\ensuremath{\Pi_\GS}}
\nc{\VGS}{\ensuremath{V_\GS}}
\nc{\PGS}{\ensuremath{P_\GS}}
\nc{\PGSstar}{\ensuremath{P_\GS^*}}
\nc{\cVGS}[1]{\ensuremath{\cV_{\GS,#1}}}
\nc{\cPGS}[1]{\ensuremath{\cP_{\GS,#1}}}

\def\Samp{\mathsf{Samp}}
\nc{\PiSamp}{\ensuremath{\Pi_\Samp}}
\nc{\VSamp}{\ensuremath{V_\Samp}}
\nc{\PSamp}{\ensuremath{P_\Samp}}
\nc{\PSampstar}{\ensuremath{P_\Samp^*}}
\nc{\cVSamp}[1]{\ensuremath{\cV_{\Samp,#1}}}
\nc{\cPSamp}[1]{\ensuremath{\cP_{\Samp,#1}}}

\def\GS{\mathsf{GS}}

\begin{lemma}
	\label{ProtoGroundStateCheck}
	There is a $\QPIP_1$ protocol $\PiGS$ for \cref{AlgGroundStateCheck}. Furthermore, in this protocol, the verifier doesn't need to apply any gates, and only needs to apply $X$ and $Z$ measurements.
\end{lemma}
\begin{prf}
	The prover simply sends the input qubit-by-qubit for the verifier to measure. It is clear that any attacks on this scheme trivially maps onto an attack on the original scheme.
\end{prf}

Now we present \hyperref[ProtoQPIP1]{Protocol~\ref*{ProtoQPIP1}}, a $\QPIP_1$ protocol for any $\SampBQP$ problem with inverse polynomial error in circuit size.

\begin{protocol}{$\QPIP_1$ protocol $\PiSamp$ for $\SampBQP$ with soundness error $O(\varepsilon)$}
	\label{ProtoQPIP1}
	Let $C'$ be $C$ padding with enough identity gates so that...
	Let $n$ be large enough so by Chernoff bound
		$$P\left[Bin(n, \frac{1}{2}-2\varepsilon)\geq\left(\frac{1}{2}-\varepsilon\right)n\right]<\varepsilon$$
		$$P\left[Bin(n, \frac{1}{2})\leq\left(\frac{1}{2}-\varepsilon\right)n\right]<\varepsilon$$
	Let $N$ be large enough so that by de Finetti's theorem...
		That is,
		$$\sqrt{\frac{2(m+n)^2\ln\abs{A}}{N-(m+n)}}<\varepsilon$$
		where $\abs{A}$ is the number of qubits in $\ket{\psi_{C(x)}}$
	\begin{enumerate}
		\item The honest prover prepares $N$ copies of $\ket{\psi_{C'(x)}}$
		\item The verifier privately samples $I\subset[N]$ s.t. $\abs{I}=n$. It then privately samples $k\in[N]\setminus I$.
		\item For $i$ from $1$ to $N$:
		\begin{enumerate}
			\item The prover sends the $i$-th copy of $\ket{\psi_{C'(x)}}$, $\rho_i$, qubit-by-qubit.
			\item If $i\in I$, the verifier runs $\cA_{\GS}$ on $\rho_i$. Otherwise, if $i=k$, the verifier measures the data register of $\rho_i$ and save the outcome as $y$. Otherwise the verifier discards $\rho_i$.
		\end{enumerate}
		\item If the proportion of copies accepted by $\cA_{\GS}$ is greater than $\frac{1}{2}-\varepsilon$ then the client accepts and outputs $y$. Otherwise, it rejects.
	\end{enumerate}
\end{protocol}

\begin{thm}
    \label{QPIP1thm}
	For any $L\in\SampBQP$, \hyperref[ProtoQPIP1]{Protocol~\ref*{ProtoQPIP1}} is a protocol for $L$ with negligible completeness. $\forall c\in\bbN$, it achieves soundness $(\varepsilon, \varepsilon)$ where $\varepsilon=T^{-c}$. Furthermore, in this protocol, the verifier doesn't need to apply any gates, and only needs to apply $X$ and $Z$ measurements.
\end{thm}
\begin{prf}
	It clearly has completeness negligibly close to $1$. Now we analyze soundness against a possibly cheating prover that has at least $\delta$ probability to be accepted. Let $\sigma$ be the state the prover sends to the verifier.

	Picking $n+m$ out of $N$ registers is equivalent to first applying a random permutation then taking the first $n+m$ registers.
	A random permutation is equivalent to a classical mix over all possible permutations of $\sigma$:

	$$\sigma'=\frac{1}{\abs{\Sym(N)}}\sum_{\Pi\in\Sym(N)}\Pi\sigma\Pi^\dagger$$

	Now we verify that $\sigma'$ is permutation-invariant.
	Let $\tilde{\Pi}$ be some fixed permutation, then clearly:
	$$\tilde{\Pi}\sigma'\tilde{\Pi}^\dagger=\sigma'$$

	So we can apply \cref{deFinetti}. $\exists\set{w_i, \rho_i}$ such that:
	$$\max_{\Lambda_i}\norm{\Lambda_1\otimes\ldots\otimes\Lambda_{m+n}(\sigma'-\sum_i w_i\rho_i^{\otimes n+m})}=O(\varepsilon)$$

	Note that $\tilde\sigma=\sum_i w_i\rho_i^{\otimes n+m}$ is a classical mix over $\rho_i^{\otimes n+m}$ with weights $w_i$.

	Let $p_i$ be the accept probability of at least $(\frac{1}{2}-\varepsilon)n$ copies from $\rho_i^{\otimes n}$ accept under \cref{AlgGroundStateCheck}.
	So the accept chance of this prover is $\sum_j w_j p_j>\delta$
	By Bayes' theorem, conditioned on acceptance, the probability of $\tilde{\sigma}$ being $\rho_i^{\otimes n+m}$ is then $\frac{w_i p_i}{\sum_j w_j p_j}$.

	Let
	$$J=\set{j:q_j\leq P\left[Bin(n, \frac{1}{2}-2\varepsilon)\geq\left(\frac{1}{2}-\varepsilon\right)n\right]}$$

	Recall that then each $q_j$ must be negligible by how we picked $n$. Hence the following is clearly negligible:
	$$\sum_{j\in J} w_j q_j$$

	And so is
	$$\frac{\sum_{j\in J} w_j q_j}{\sum_i w_i q_i}=\frac{\sum_{j\in J} w_j q_j}{\delta}$$

	So by Bayes' theorem, conditioned on acceptance, the probability of $\tilde{\sigma}$ being $\rho_i^{\otimes n+m}$ where $\rho_i$ has over probability $1-2\varepsilon$ to be accepted by \cref{AlgGroundStateCheck} is overwhelming.

	Such $\rho_i$ is $O(\negl(\varepsilon))$-close to $\ket{\psi_{C'(x)}}$, by applying a Chernoff bound to \cref{ThmXZCheck}.

	The probability of measuring $t\geq T$ on the clock register of $\ket{\psi_{C'(x)}}$ is $\frac{1}{2}$, so the probability of failing to do so after $m$ attempts is negligible.
	Once we do measure $t\geq T$, the data register is $C(x)$.

	All errors up to this point is $O(\varepsilon)$.
\end{prf}

